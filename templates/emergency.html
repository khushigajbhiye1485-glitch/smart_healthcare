{% extends "base.html" %}
{% block content %}
<div class="sos-wrapper">
  <div class="sos-card">
    <h1>üö® Emergency SOS</h1>
    <p class="subtext">
      Your live location will be detected automatically.  
      Click the button below to immediately alert the nearest ambulance driver.
    </p>

    <!-- SOS Button -->
    <button class="sos-btn" onclick="sendSOS()">üöë Send SOS Now</button>

    <!-- Status Message -->
    <p id="statusMsg" class="status-msg"></p>

    <!-- Map Preview -->
    <div id="map" class="map-preview"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let map, marker;
  let currentLat, currentLon;

  // Initialize Map
  function initMap(lat, lon) {
    if (!map) {
      map = L.map('map').setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([lat, lon]).addTo(map)
        .bindPopup("üìç Your Location")
        .openPopup();
    } else {
      map.setView([lat, lon], 15);
      marker.setLatLng([lat, lon]);
    }
  }

  // Detect location on load
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      currentLat = position.coords.latitude;
      currentLon = position.coords.longitude;
      initMap(currentLat, currentLon);
    }, function() {
      document.getElementById("statusMsg").innerText = "‚ö†Ô∏è Unable to detect location.";
    });
  } else {
    document.getElementById("statusMsg").innerText = "‚ùå Geolocation not supported.";
  }

  // Send SOS request
  function sendSOS() {
    if (!currentLat || !currentLon) {
      document.getElementById("statusMsg").innerText = "‚ö†Ô∏è Location not available.";
      return;
    }

    document.getElementById("statusMsg").innerText = "üì° Sending SOS...";

    fetch("/api/send-sos", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ lat: currentLat, lon: currentLon })
    })
    .then(res => res.text()) // backend returns HTML
    .then(html => {
      document.open();
      document.write(html);
      document.close();
    })
    .catch(err => alert("‚ùå Error: " + err));
  }
</script>

<style>
  body {
    background: linear-gradient(135deg, #ff4e50, #f9d423);
    font-family: 'Segoe UI', sans-serif;
  }

  .sos-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 50px 20px;
  }

  .sos-card {
    background: #fff;
    border-radius: 15px;
    padding: 30px;
    max-width: 700px;
    width: 100%;
    text-align: center;
    box-shadow: 0 6px 25px rgba(0,0,0,0.2);
    animation: fadeIn 0.8s ease-in-out;
  }

  h1 {
    color: #dc3545;
    margin-bottom: 15px;
    font-size: 2.8em;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  }

  .subtext {
    font-size: 1.2em;
    margin-bottom: 25px;
    color: #555;
  }

  .sos-btn {
    font-size: 1.6em;
    padding: 20px 60px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 0 20px rgba(220, 53, 69, 0.7);
    transition: transform 0.2s ease, background 0.3s ease;
    animation: pulse 1.5s infinite;
  }

  .sos-btn:hover {
    transform: scale(1.1);
    background: #b02a37;
  }

  .status-msg {
    margin-top: 20px;
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
  }

  .map-preview {
    margin: 30px auto;
    width: 90%;
    height: 350px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 15px rgba(220,53,69,0.6); }
    50% { box-shadow: 0 0 40px rgba(220,53,69,1); }
    100% { box-shadow: 0 0 15px rgba(220,53,69,0.6); }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
{% endblock %}
